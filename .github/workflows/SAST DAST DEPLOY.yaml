name: SAST and DAST Scan with Deployment for Django Project

on:
  push:
    branches:
      - main

jobs:
  build-and-sast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Check Django migrations
        run: |
          python manage.py check --deploy
          python manage.py makemigrations --dry-run --check

      - name: Start local Django server in background
        run: |
          python manage.py runserver 0.0.0.0:8000 &
          sleep 10

      - name: Install Bandit for Python SAST
        run: |
          pip install bandit

      - name: Run Bandit (Python) for SAST
        run: |
          bandit -r . -f json -o bandit-report.json || true

      - name: Extract critical issues from Bandit report
        run: |
          jq '[.results[] | select(.issue_severity == "HIGH")]' bandit-report.json > critical-bandit-report.json

      - name: Install ESLint for JavaScript SAST
        run: |
          npm install eslint -g

      - name: Run ESLint for JavaScript
        run: |
          eslint --format=json --output-file=eslint-report.json static/js/*.js || true

      - name: Install Stylelint for CSS SAST
        run: |
          npm install stylelint -g

      - name: Run Stylelint for CSS
        run: |
          stylelint --format=json --output-file=stylelint-report.json static/css/*.css || true

      - name: Create SAST Issue
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SAST Scan Results (Critical Issues)"
          content-filepath: ./critical-bandit-report.json
          labels: sast, security

      - name: Upload SAST reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: sast-reports
          path: |
            bandit-report.json
            critical-bandit-report.json
            eslint-report.json
            stylelint-report.json

  dast-scan:
    runs-on: ubuntu-latest
    needs: build-and-sast
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Start local Django server
        run: |
          python manage.py runserver 0.0.0.0:8000 &
          sleep 10

      - name: Generate a random free port for ZAP
        run: |
          export ZAP_PORT=$(python3 -c 'import socket; s=socket.socket(); s.bind(("", 0)); print(s.getsockname()[1]); s.close()')
          echo "ZAP_PORT=$ZAP_PORT" >> $GITHUB_ENV

      - name: Set unique ZAP home directories
        run: |
          export DAEMON_ZAP_HOME=$(mktemp -d)
          echo "DAEMON_ZAP_HOME=$DAEMON_ZAP_HOME" >> $GITHUB_ENV
          export SCRIPT_ZAP_HOME=$(mktemp -d)
          echo "SCRIPT_ZAP_HOME=$SCRIPT_ZAP_HOME" >> $GITHUB_ENV

      - name: Start ZAP in background with Docker from GitHub Registry
        run: |
          docker run --rm -d \
            -u zap \
            -p ${{ env.ZAP_PORT }}:8080 \
            -v "$DAEMON_ZAP_HOME":/home/zap/.ZAP_D/ \
            --name zap-daemon \
            ghcr.io/zaproxy/zap-weekly:latest \
            zap.sh -daemon -port 8080 -host 0.0.0.0 -config api.disablekey=true

      - name: Wait for ZAP to start
        run: |
          sleep 30

      - name: Create ZAP script for DAST
        run: |
          cat << 'EOF' > "$DAEMON_ZAP_HOME/zap-script.js"
          var targetUrl = "http://localhost:8000/";
          var scanPolicyName = "Default Policy";

          var client = new org.zaproxy.clientapi.core.ClientApi("localhost", ${{ env.ZAP_PORT }});

          try {
            var version = client.core.version();
            print("Connected to ZAP API version: " + version);
          } catch (e) {
            print("Error: Failed to connect to ZAP API.");
            exit(1);
          }

          var scanId = client.ascan.scan(targetUrl, null, null, null, null, scanPolicyName);

          while (true) {
            var status = client.ascan.status(scanId);
            print("Scan progress: " + status + "%");
            if (status >= 100) {
              break;
            }
            java.lang.Thread.sleep(5000);
          }

          var reportDir = "$SCRIPT_ZAP_HOME/zap-reports";
          client.reports.generate(targetUrl, "traditional-html", null, reportDir + "/zap-report.html", null, null, null, null, null);
          client.reports.generate(targetUrl, "json", null, reportDir + "/zap-report.json", null, null, null, null, null);
          EOF

      - name: Run ZAP script with Docker
        run: |
          docker exec zap-daemon zap.sh -cmd -script "$DAEMON_ZAP_HOME/zap-script.js" -dir "$SCRIPT_ZAP_HOME"

      - name: Stop ZAP container
        run: |
          docker stop zap-daemon || true

      - name: Upload DAST reports as artifact
        uses: actions/upload-artifact@v4
        with:
          name: dast-reports
          path: ${{ env.SCRIPT_ZAP_HOME }}/zap-reports

      - name: Create DAST Issue with report links
        uses: peter-evans/create-or-update-issue@v2
        with:
          title: "DAST Scan Results"
          body: |
            The DAST scan has been completed. Below are the results:
            - HTML Report: [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
            - JSON Report: [Download](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}/artifacts)
          labels: dast, security
          assignees: ${{ github.actor }}
            
      - name: Clean up ZAP directories
        run: |
          rm -rf "$DAEMON_ZAP_HOME"
          rm -rf "$SCRIPT_ZAP_HOME"
