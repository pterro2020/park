name: SAST and DAST Scan with Deployment

on:
  push:
    branches:
      - main

jobs:
  sast-scan:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Получаем всю историю, чтобы SAST мог анализировать все файлы

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'  # Устанавливаем нужную версию Python

      - name: Install Bandit
        run: |
          python -m pip install --upgrade pip
          pip install bandit  # Устанавливаем Bandit для SAST

      - name: Run Bandit (Python)
        run: |
          bandit -r . -f json -o bandit-report.json || true  # Запускаем SAST для Python и сохраняем отчет в JSON формате, игнорируем ошибки

      - name: Extract critical issues from Bandit report
        run: |
          # Для уменьшения объема извлекаем только критические ошибки из отчета Bandit
          jq '[.results[] | select(.issue_severity == "HIGH")]' bandit-report.json > critical-bandit-report.json

      - name: Create SAST Issues
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "SAST Scan Results (Critical Issues)"
          content-filepath: ./critical-bandit-report.json
          labels: sast, security

      - name: Upload SAST reports
        uses: actions/upload-artifact@v4
        with:
          name: reports
          path: |
            bandit-report.json
            critical-bandit-report.json

  dast-scan:
    runs-on: ubuntu-latest
    needs: sast-scan  # DAST будет выполнен после завершения SAST
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install jq
        run: sudo apt-get install -y jq  # Устанавливаем jq для работы с JSON

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt  # Устанавливаем зависимости для вашего приложения

      - name: Start local server
        run: |
          # Запускаем локальный сервер в фоновом режиме
          python -m flask run --host=0.0.0.0 --port=5000 &
          sleep 10  # Ждем, пока сервер запустится

      - name: Set unique ZAP home directory
        run: |
          # Создаем уникальную временную директорию для домашней директории ZAP
          export ZAP_HOME=$(mktemp -d)
          echo "ZAP_HOME set to: $ZAP_HOME"
          echo "ZAP_HOME=$ZAP_HOME" >> $GITHUB_ENV  # Сохраняем переменную в окружении

      - name: Download ZAP
        run: |
          mkdir -p "$ZAP_HOME/ZAP_2.15.0"
          wget -qO- https://github.com/zaproxy/zaproxy/releases/download/v2.15.0/ZAP_2.15.0_Linux.tar.gz | tar xz -C "$ZAP_HOME/ZAP_2.15.0" --strip-components=1

          # Проверяем, что ZAP скачан
          if [ ! -f "$ZAP_HOME/ZAP_2.15.0/zap.sh" ]; then
            echo "Error: ZAP download failed."
            exit 1
          fi
      - name: Create reports directory
        run: |
          mkdir -p "$ZAP_HOME/zap-reports"  # Создаем директорию для отчетов ZAP

      - name: Start ZAP in background
        run: |
          # Запускаем ZAP с указанием домашней директории
          "$ZAP_HOME/ZAP_2.15.0/zap.sh" -daemon -port 8080 -host 0.0.0.0 -config api.disablekey=true -dir "$ZAP_HOME" &
          sleep 30  # Ждем, пока ZAP запустится

      - name: Create ZAP script for DAST
        run: |
          # Создаем файл zap-script.js для DAST сканирования
          cat << 'EOF' > "$ZAP_HOME/ZAP_2.15.0/zap-script.js"

          // Скрипт для ZAP
          var targetUrl = "http://localhost:5000/"; // URL вашего локального приложения
          var scanPolicyName = "Default Policy"; // Используемая политика сканирования

          // Инициализация ZAP
          print("Initializing ZAP...");
          var client = new org.zaproxy.clientapi.core.ClientApi("localhost", 8080);

          // Проверка доступности ZAP API
          try {
          var version = client.core.version();
          print("Connected to ZAP API version: " + version);
          } catch (e) {
          print("Error: Failed to connect to ZAP API. Make sure ZAP is running and the API is accessible.");
          exit(1);
          }

          // Запуск сканирования
          print("Starting active scan for: " + targetUrl);
          var scanId = client.ascan.scan(targetUrl, null, null, null, null, scanPolicyName);
          // Ожидание завершения сканирования
          print("Waiting for scan to complete...");
          while (true) {
          var status = client.ascan.status(scanId);
          print("Scan progress: " + status + "%");
          if (status >= 100) {
          break;
          }
          java.lang.Thread.sleep(5000); // Пауза 5 секунд
          }

          // Генерация отчетов
          print("Generating reports...");
          var reportDir = "$ZAP_HOME/zap-reports";
          client.reports.generate(targetUrl, "traditional-html", null, reportDir + "/zap-report.html", null, null, null, null, null);
          client.reports.generate(targetUrl, "json", null, reportDir + "/zap-report.json", null, null, null, null, null);
          print ("Reports generated successfully.");
          EOF

      - name: Run ZAP script
        run: |
          "$ZAP_HOME/ZAP_2.15.0/zap.sh" -cmd -script "$ZAP_HOME/ZAP_2.15.0/zap-script.js" -dir "$ZAP_HOME"

      - name: Upload DAST report
        uses: actions/upload-artifact@v4
        with:
          name: zap-reports
          path: zap-reports  # Загружаем отчеты DAST как артефакт

      - name: Create DAST Issues
        uses: peter-evans/create-issue-from-file@v4
        with:
          title: "DAST Scan Results"
          content-filepath: ./zap-reports/zap-report.json
          labels: dast, security

      - name: Clean up ZAP directory
        run: |
          # Удаляем папку ZAP_2.15.0 после завершения DAST
          rm -rf ./ZAP_2.15.0
          echo "ZAP directory cleaned up."

  deploy:
    runs-on: ubuntu-latest
    needs: dast-scan  # Развертывание будет выполнено после завершения DAST
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install SSH key
        uses: shimataro/ssh-key-action@v2
        with:
          key: ${{ secrets.SSH_PRIVATE_KEY }}  # Приватный SSH-ключ
          known_hosts: ${{ secrets.KNOWN_HOSTS }}  # Известные хосты

      - name: Copy files to remote server
        run: |
          # Копируем файлы на удаленный сервер с помощью rsync
          rsync -avz --delete -e "ssh -o StrictHostKeyChecking=no" ./ ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }}:/var/www/park/

      - name: Install dependencies on remote server
        run: |
          # Устанавливаем зависимости на удаленном сервере
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            cd /var/www/park &&
            python -m pip install --upgrade pip &&
            pip install -r requirements.txt
          "

      - name: Restart application on remote server
        run: |
          # Перезапускаем приложение на удаленном сервере
          ssh -o StrictHostKeyChecking=no ${{ secrets.SSH_USER }}@${{ secrets.SSH_HOST }} "
            sudo systemctl restart park.service"

